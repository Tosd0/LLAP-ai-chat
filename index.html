<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>IDIC实验室</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="fix-colors.css">

    <style>
            .message-context-menu { position: fixed; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 5px; z-index: 1000; display: none; }
            .context-menu-item { padding: 8px 12px; cursor: pointer; font-size: 14px; border-radius: 5px; }
            .context-menu-item:hover { background-color: #f0f0f0; }
            .quoted-message-display { display: block; background-color: rgba(0,0,0,0.05); padding: 6px 10px; margin: -2px -2px 8px; border-radius: 8px 8px 0 0; font-size: 13px; color: #555; border-left: 3px solid var(--main-theme-color, #3B83A2);  }
            .quoted-message-display .sender-name { font-weight: bold; }
            .quoted-message-display .message-snippet { display: block; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
            .reply-indicator { background-color: #f0f4f8; padding: 5px 10px; font-size: 12px; color: #333; display: none; align-items: center; justify-content: space-between; }
            .reply-indicator-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            .cancel-reply-btn { cursor: pointer; font-size: 16px; font-weight: bold; padding: 0 5px; }
            .message-recalled { color: #888; font-size: 12px; text-align: center; padding: 10px 0; width: 100%; }
            .recalled-edit-btn { color: #3B83A2; cursor: pointer; margin-left: 5px; }
        </style>
     <link rel="stylesheet" href="style.css">
    <!-- ▼▼▼ 【【【全新：引入flatpickr日历样式】】】 ▼▼▼ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ba7f37e3381acad0f7ea1fafa4697bb8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
</head>
<body>
    <div id="app-wrapper"></div>
    <!-- ▼▼▼▼▼ 【全新】侧滑菜单 (个人中心) ▼▼▼▼▼ -->
    <div id="side-menu" class="side-menu">
        <div class="side-menu-profile">
            <img id="side-menu-avatar" class="avatar-large" src="https://i.postimg.cc/cLPP10Vm/4.jpg">
            <span id="side-menu-username">你的昵称</span>
            <!-- 可以在这里加更多个人信息 -->
        </div>
        <div class="side-menu-list">
            <div class="side-menu-item" id="side-menu-wallet">
                <span class="menu-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4h-4z"></path></svg></span>
                <span>钱包</span>
            </div>
            <div class="side-menu-item" id="side-menu-ledger">
                <span class="menu-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg></span>
                <span>账本</span>
            </div>
            <div class="side-menu-item" id="side-menu-favorites">
                <span class="menu-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg></span>
                <span>收藏</span>
            </div>
            <div class="side-menu-item" id="side-menu-themes">
                <span class="menu-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"></path></svg></span>
                <span>个性装扮</span>
            </div>
        </div>
        <div class="side-menu-footer">
            <span>设置</span>
            <span>夜间</span>
            <span>--_--</span>
        </div>
    </div>
    <!-- ▲▲▲▲▲ 侧滑菜单结束 ▲▲▲▲▲ -->
     <!-- ▼▼▼ 【【【全新：侧滑菜单遮罩层】】】 ▼▼▼ -->
    <div id="sidebar-overlay" class="sidebar-overlay hidden"></div>
    <!-- ▲▲▲▲▲ 遮罩层结束 ▲▲▲▲▲ -->

    <div id="message-context-menu" class="message-context-menu">
        <div class="context-menu-item" id="context-menu-reply">引用</div>
        <div class="context-menu-item" id="context-menu-recall">撤回</div>
    </div>

    <!-- 【【【全新：全局Toast提示】】】 -->
    <div id="global-toast" class="hidden">
        <span id="global-toast-text"></span>
    </div>

    <div id="app-container">

        <!-- 视图0: 登录页面 -->
        <div id="login-view" class="view hidden">
            <div class="login-container">
                <img src="https://i.postimg.cc/kXq06mNq/ai-default.png" alt="Logo" class="login-logo">
                <h1 class="login-title">你的 AI 伙伴</h1>
                <p class="login-subtitle">即刻登录，继续你们的故事</p>
                <button id="login-button" class="login-button">登录</button>
                <a href="#" id="login-to-settings-link" class="login-settings-link">还没有配置？前往设置</a>
            </div>
            <div class="login-footer-branding">
                <p class="branding-title"><strong>I D I C</strong></p>
                <p class="branding-subtitle">Infinite Diversity in Infinite Combinations.</p>
            </div>
        </div>

        <!-- 视图1: 消息列表 (默认视图) -->
        <div id="chat-list-view" class="view hidden">
            <div class="main-header">
                <div id="main-header-user-info" class="user-info-bar">
                    <img id="main-header-avatar" class="avatar" src="https://i.postimg.cc/cLPP10Vm/4.jpg">
                    <div class="user-details">
                        <span id="main-header-username">你的昵称</span>
                        <span class="user-status"><span class="status-dot"></span>在线 - 5G</span>
                    </div>
                </div>
                <button id="add-contact-button" class="header-button">+</button>
            </div>
            <div class="search-bar-container">
                <div class="search-bar">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="chat-list-search-input" class="search-input" placeholder="搜索聊天记录...">
                    <button id="toggle-filters-btn" class="tool-button" title="筛选"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M7 12h10M10 18h4"></path></svg></button>
                </div>
                <!-- ▼▼▼ 【【【全新：高级搜索筛选器面板】】】 ▼▼▼ -->
            <div id="search-filters-panel" class="search-filters-panel">
                <div class="filters-content"> <!-- ▼▼▼ 在这里增加一个 div ▼▼▼ -->
                    <div class="filter-group">
                        <label for="char-filter-select">指定角色</label>
                        <select id="char-filter-select">...</select>
                    </div>
                    <div class="filter-group">
                        <label for="date-filter-input">指定日期</label>
                        <input type="text" id="date-filter-input" placeholder="点击选择日期..." readonly>
                    </div>
                </div> <!-- ▲▲▲ 增加的 div 在这里结束 ▲▲▲ -->
                <!-- ▼▼▼ 【全新】筛选操作按钮 ▼▼▼ -->
                <div class="filters-actions">
                    <button id="reset-filters-btn">重置</button>
                    <button id="apply-filters-btn">应用筛选</button>
                </div>
                <!-- ▲▲▲▲▲ 操作按钮结束 ▲▲▲▲▲ -->
            </div>
            <!-- ▲▲▲▲▲ 筛选器面板结束 ▲▲▲▲▲ -->
            </div>
            
            <div id="chat-list-container" class="chat-list">
                <!-- 聊天列表将由JS动态生成在这里 -->
            </div>
        </div>

        <!-- 视图2: 聊天窗口 -->
        <div id="chat-window-view" class="view hidden">
            <div class="header">
                <div id="chat-header-normal">
                    <button id="back-to-list-button" class="header-button back-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                    <div id="chat-header-info">
                        <span id="chat-ai-name" class="clickable">AI 伙伴</span>
                        <div id="chat-ai-status-line">
                            <span class="online-indicator"></span>
                            <span id="chat-ai-status">在线</span>
                            <span id="chat-ai-activity-status"></span>
                        </div>
                    </div>
                    <button id="chat-settings-button" class="header-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
                </div>
                <div id="chat-header-select" class="chat-header-actions hidden">
    <!-- 【【【核心修复1：把取消按钮的样式类改掉，它就不会那么大了】】】 -->
    <button id="cancel-select-button" class="header-button-text">取消</button>
    <span id="select-count"></span>
    <div class="header-action-buttons">
        <!-- 【【【核心修复2：用SVG图标彻底替换掉汉字】】】 -->
        <!-- 撤回按钮 (图标：标准撤销) -->
        <button id="recall-selected-button" class="header-button" title="撤回">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>
        </button>
        <!-- 引用按钮 (图标：回复) -->
        <button id="reply-selected-button" class="header-button" title="引用">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10h10a8 8 0 0 1 8 8v2M3 10l4-4M3 10l4 4"/></svg>
        </button>
        <!-- 编辑按钮 (图标：铅笔) -->
        <button id="edit-selected-button" class="header-button" title="编辑">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        </button>
        <!-- 删除按钮 (图标：垃圾桶) -->
        <button id="delete-selected-button" class="header-button" title="删除">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/></svg>
        </button>
    </div>
</div>
            </div>
            <div id="message-container">
                <div id="load-more-btn" class="load-more-btn hidden">加载更早的记录</div>
            </div>
            <div id="ai-suggestion-panel" class="suggestion-panel hidden">
            </div>
            <div class="chat-input-area">
                <div id="refresh-suggestions-container" class="hidden">
                    <button id="refresh-suggestions-btn" title="换一批"></button>
                </div>
                <!-- ▼▼▼ 【【【全新：扩展功能面板】】】 ▼▼▼ -->
                <div id="extended-functions-panel">
                    <div class="more-functions-grid">
                        <!-- 视频通话 -->
                        <div class="function-item" id="fn-video-call">
                            <div class="function-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15.6 11.6L22 7v10l-6.4-4.6v-1zM4 6h10a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"></path></svg></div>
                            <span class="function-label">视频通话</span>
                        </div>
                        <!-- 记账 -->
                        <div class="function-item" id="fn-accounting">
                            <div class="function-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 22H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2z"></path><path d="M12 6v12M17 7l-5 5-5-5"></path></svg></div>
                            <span class="function-label">记账</span>
                        </div>
                        <!-- 亲密关系 -->
                        <div class="function-item" id="fn-relationship">
                            <div class="function-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></div>
                            <span class="function-label">亲密关系</span>
                        </div>
                        <!-- 一起听歌 -->
                        <div class="function-item" id="fn-listen-together">
                            <div class="function-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg></div>
                            <span class="function-label">一起听歌</span>
                        </div>
                        <!-- 礼物 -->
                        <div class="function-item" id="fn-gift">
                            <div class="function-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 12 20 22 4 22 4 12"></polyline><rect x="2" y="7" width="20" height="5"></rect><line x1="12" y1="22" x2="12" y2="7"></line><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path></svg></div>
                            <span class="function-label">礼物</span>
                        </div>
                        <!-- 日记本 -->
                        <div class="function-item" id="fn-diary">
                            <div class="function-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg></div>
                            <span class="function-label">日记本</span>
                        </div>
                    </div>
                </div>
                <!-- ▲▲▲ 扩展功能面板结束 ▲▲▲ -->
                <div class="chat-functions-toolbar">
                    <button id="voice-btn" class="tool-button" title="语音"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line></svg></button>
                    <button id="image-btn" class="tool-button" title="图片"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></button>
                    <button id="camera-btn" class="tool-button" title="拍摄"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg></button>
                    <button id="red-packet-btn" class="tool-button" title="红包"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.2c-5.5 0-10 2.4-10 6.8 0 2.4.6 4.6 2.4 6.4 1.8 2 4.2 2.6 4.2 4.6 0 1.1.9 2 2 2h2.8c1.1 0 2-.9 2-2 0-2 2.4-2.6 4.2-4.6 1.8-1.8 2.4-4 2.4-6.4 0-4.4-4.5-6.8-10-6.8z"></path><path d="M12 12.6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg></button>
                    <button id="emoji-btn" class="tool-button" title="表情"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg></button>
                    <button id="ai-helper-button" class="tool-button" title="AI帮回"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8V4H8"></path><rect x="4" y="4" width="16" height="16" rx="2"></rect><path d="M20 12h-4"></path><path d="M12 20v-4"></path></svg></button>
                    <button id="more-functions-button" class="tool-button" title="更多"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg></button>
<button id="close-extended-functions-btn" class="tool-button hidden" title="关闭"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>
                <div id="reply-indicator" class="reply-indicator">
                    <span id="reply-indicator-text"></span>
                    <span id="cancel-reply-btn" title="取消回复">&times;</span>
                </div>
                <div class="input-row">
                    <textarea id="chat-input" placeholder="输入消息..."></textarea>
                    <button id="send-button">发送</button>
                </div>
            </div>
            <div id="user-sticker-panel" class="sticker-panel"></div>
        </div>
        
        <!-- 视图3: 动态页面 -->
        <div id="moments-view" class="view hidden">
            <div class="header">
                 <button id="back-to-list-from-moments" class="header-button back-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <span>动态</span>
            </div>
            <div class="moments-container">
                <div class="moments-header">
                    <img class="moments-banner" src="https://i.postimg.cc/L8y2zWc2/default-banner.jpg" alt="banner">
                    <div class="moments-user-info">
                        <span id="moments-user-name">你的昵称</span>
                        <img id="moments-user-avatar" class="avatar-lg" src="">
                    </div>
                </div>
                <div class="moments-nav">
                    <span>相册</span>
                    <span>说说</span>
                    <span>装扮</span>
                    <span>游戏</span>
                </div>
                <div class="moments-feed"></div>
                 <button id="create-post-button" class="fab">+</button>
            </div>
        </div>

        <!-- 视图4: 设置页面 (通用设置) -->
        <div id="settings-view" class="view hidden">
            <div class="header">
                 <button id="back-to-list-from-settings" class="header-button back-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <span>设置</span>
            </div>
            <div id="settings-form">
                <div class="form-group"><label for="api-type-select">API 类型</label><select id="api-type-select"><option value="openai_proxy">OpenAI 格式 (推荐)</option><option value="gemini_direct" disabled>Google Gemini (暂不推荐)</option></select></div>
                <div class="form-group"><label for="api-url-input">API 地址 (URL)</label><input type="text" id="api-url-input" placeholder="根据所选类型填写"></div>
                <div class="form-group" id="model-area"><label>模型名称 (Model)</label><div class="model-selection-area"><select id="api-model-select"></select><button id="fetch-models-button">拉取</button></div></div>
                <div class="form-group"><label for="api-key-input">API 密钥 (Key)</label><input type="password" id="api-key-input" placeholder="粘贴你的密钥"></div>
                <div class="form-group">
                    <label for="context-limit-input">上下文记忆条数</label>
                    <input type="number" id="context-limit-input" placeholder="">
                </div>

                <!-- ▼▼▼ 【【【全新：数据导入/导出功能区】】】 ▼▼▼ -->
                <div class="settings-group">
                    <div class="settings-item" id="export-data-button">
                        <span>导出全部数据</span>
                        <span class="arrow">&gt;</span>
                    </div>
                    <div class="settings-item" id="import-data-button">
                        <span>导入全部数据</span>
                        <span class="arrow">&gt;</span>
                    </div>
                </div>
                <!-- ▲▲▲▲▲ ▲▲▲▲▲ -->

                <hr>
                <!-- ▼▼▼ 【【【全新：为用户和AI分别添加入口】】】 ▼▼▼ -->
                <div class="settings-group">
                <div class="settings-item" id="manage-my-stickers-entry">
                    <span>我的表情包</span>
                    <span class="arrow">&gt;</span>
                </div>
                <div class="settings-item" id="manage-ai-stickers-entry">
                    <span>AI表情包仓库管理</span>
                    <span class="arrow">&gt;</span>
                </div>
            </div>
                <!-- ▲▲▲▲▲ ▲▲▲▲▲ -->
                <h3>全局设置 (待开发)</h3>
                <p class="placeholder-text">未来可在这里添加全局预设、外观等设置。</p>
                <button id="save-settings-button">保存设置</button>
            </div>
        </div>
        <!-- 【【【AI表情包仓库管理页面 (请确保此代码块完整存在)】】】 -->
        <div id="ai-sticker-manager-view" class="view hidden">
            <div class="header">
                <button id="back-to-settings-from-sticker-manager-btn" class="header-button back-button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </button>
                <span>AI表情包仓库管理</span>
            </div>
            
            <!-- ▼▼▼ 罪魁祸首就是下面这个div在您的文件中缺失了 ▼▼▼ -->
            <div id="sticker-manager-container" class="sticker-manager-container">
                <!-- 表情包分组将由JS动态生成在这里 -->
            </div>
            <!-- ▲▲▲▲▲ -->

            <button id="add-sticker-group-btn" class="fab">+</button>
        </div>

        <!-- 视图5: 单个联系人的聊天设置页面 -->
        <div id="contact-settings-view" class="view hidden">
            <div class="header">
                 <button id="back-to-chat-button" class="header-button back-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <span>聊天设置</span>
            </div>
            <div class="contact-settings-container">
                <div class="settings-group">
                    <div class="settings-item contact-profile" id="cs-edit-ai-profile">
                        <img id="cs-contact-avatar" class="avatar" src="">
                        <span>对方信息</span>
                        <span class="arrow">&gt;</span>
                    </div>
                    <div class="settings-item contact-profile" id="cs-edit-my-profile">
                        <img id="cs-my-avatar" class="avatar" src="">
                        <span>我的身份</span>
                        <span class="arrow">&gt;</span>
                    </div>
                </div>
                                <div class="settings-group">
                    <div class="settings-item"><span>设为置顶</span><label class="switch"><input type="checkbox" id="cs-pin-toggle"><span class="slider"></span></label></div>
                    <div class="settings-item">
                        <span>允许AI主动求爱</span>
                        <label class="switch"><input type="checkbox" id="cs-propose-toggle"><span class="slider"></span></label>
                    </div>
                </div>

                                <!-- ▼▼▼ 【【【全新：真实作息模拟，就放在这里！】】】 ▼▼▼ -->
                <div class="settings-group">
                    <div class="settings-item">
                        <span>启用真实作息模拟</span>
                        <div class="switch">
                            <input type="checkbox" id="cs-schedule-toggle">
                            <label for="cs-schedule-toggle" class="slider"></label>
                        </div>
                    </div>
                    <div class="settings-item" id="cs-edit-schedule">
                        <span>编辑生活作息</span>
                        <span class="arrow">></span>
                    </div>
                </div>
                <!-- ▲▲▲▲▲ 真实作息模拟结束 ▲▲▲▲▲ -->

                <!-- ▼▼▼ 【【【全新：线下模式，就放在这里！】】】 ▼▼▼ -->
                <div class="settings-group">
                    <div class="settings-item">
                        <span>进入线下剧情模式</span>
                        <label class="switch"><input type="checkbox" id="cs-offline-mode-toggle"><span class="slider"></span></label>
                    </div>
                    <div class="settings-item" id="cs-edit-offline-settings">
                        <span>设置线下模式</span>
                        <span class="arrow">></span>
                    </div>
<!-- 【【【全新：剧情线管理入口】】】 -->
                <div class="settings-item" id="cs-manage-storylines">
                    <span>剧情线管理</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="arrow-right"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                </div>
                <!-- ▲▲▲▲▲ 线下模式结束 ▲▲▲▲▲ -->

                <div class="settings-group">
                    <div class="settings-item"><span>导出/导入聊天记录</span><span class="arrow">&gt;</span></div>
                    <div class="settings-item" id="cs-restart-context">
                        <span>刷新AI记忆</span>
                        <span class="arrow">&gt;</span>
                    </div>
                </div>
                <div class="settings-group">
                    <div class="settings-item"><span>设置AI动态频率</span><span class="arrow">&gt;</span></div>
                </div>

                <!-- ▼▼▼ 【【【全新：主动消息功能区】】】 ▼▼▼ -->
                <div class="settings-group">
                    <div class="settings-item">
                        <span>启用主动消息</span>
                        <label class="switch"><input type="checkbox" id="cs-proactive-toggle"><span class="slider"></span></label>
                    </div>
                    <div class="settings-item" id="cs-proactive-interval-item">
                        <span>消息频率 (分钟/次)</span>
                        <input type="number" id="cs-proactive-interval-input" class="summary-threshold-input" placeholder="最低5分钟">
                    </div>
                </div>
                <!-- ▲▲▲▲▲ 主动消息功能区结束 ▲▲▲▲▲ -->
                 <!-- ▼▼▼ 【【【全新：离线消息功能区】】】 ▼▼▼ -->
                <div class="settings-group">
                    <div class="settings-item">
                        <span>启用离线消息</span>
                        <label class="switch"><input type="checkbox" id="cs-offline-msg-toggle"><span class="slider"></span></label>
                    </div>
                    <div class="settings-item" id="cs-offline-msg-interval-item">
                        <span>消息频率 (小时/次)</span>
                        <input type="number" id="cs-offline-msg-interval-input" class="summary-threshold-input" placeholder="例如：1.5 (代表一个半小时)">
                    </div>
                    <div class="settings-item" id="cs-offline-msg-sleep-item">
                        <span>休息时间</span>
                        <div class="schedule-time-range">
                           <input type="time" id="cs-offline-msg-sleep-start">
                           <span>-</span>
                           <input type="time" id="cs-offline-msg-sleep-end">
                        </div>
                    </div>
                </div>
                <!-- ▲▲▲▲▲ 离线消息功能区结束 ▲▲▲▲▲ -->
                <div class="settings-group">
                    <div class="settings-item"><span>设置聊天背景</span><span class="arrow">&gt;</span></div>
                    <div class="settings-item"><span>设置气泡样式</span><span class="arrow">&gt;</span></div>
                    <div class="settings-item"><span>设置字体大小</span><span class="arrow">&gt;</span></div>
                </div>
                <div class="settings-group">
                    <div class="settings-item" id="cs-message-count-item">
                        <span>当前对话条数</span>
                        <span id="cs-message-count">0</span>
                    </div>
                    <div class="settings-item">
                        <span>自动总结</span>
                        <div class="auto-summary-setting">
                            <div id="cs-auto-summary-display" class="summary-threshold-display">未设置</div>
                            <input type="number" id="cs-auto-summary-input" class="summary-threshold-input hidden" min="50">
                            <label class="switch"><input type="checkbox" id="cs-auto-summary-toggle"><span class="slider"></span></label>
                        </div>
                    </div>
                    <div class="settings-item" id="cs-summarize-chat">
                        <span>手动总结</span>
                        <span class="arrow">&gt;</span>
                    </div>
                </div>
                <div class="settings-group">
                    <div class="settings-item" id="cs-clear-history"><span class="danger">清空聊天记录</span></div>
                </div>
                <div class="settings-group">
                    <div class="settings-item" id="cs-blacklist-contact"><span class="danger">将对方添加至黑名单</span></div>
                </div>
                <div class="settings-group">
                    <div class="settings-item" id="cs-delete-contact">
                        <span class="danger">删除该角色</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- 【【【全新V2.0：模仿账本页面的剧情线管理页面】】】 -->
        <div class="view hidden" id="storyline-manager-view">
            <!-- 1. 页面顶部导航栏 (保持不变) -->
            <div class="header">
                <button class="header-button" id="back-to-contact-settings-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                <span class="header-title">剧情线管理</span>
            </div>

            <!-- 2. 【核心改造】为列表容器套上和账本页一样的“外套”，提供白色底框 -->
            <div class="contact-settings-container">
                <div id="storyline-list-container">
                    <!-- 剧情线列表将由JS动态生成在这里 -->
                </div>
            </div>

            <!-- 3. 新增存档的悬浮按钮 (FAB) (保持不变) -->
            <button class="fab" id="add-storyline-fab" title="新增剧情线">
                <svg xmlns="http://www.w.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </button>
        </div>
        
        <!-- 视图6: AI信息编辑页面 -->
        <div id="ai-editor-view" class="view hidden">
            <div class="header">
                <button id="back-to-contact-settings-button" class="header-button back-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <span>编辑AI信息</span>
            </div>
            <div id="ai-editor-form">
                <div class="form-group-horizontal">
                    <div class="form-group avatar-group">
                        <label>AI 头像</label>
                        <div class="image-upload-area avatar-upload" id="avatar-upload-area">
                            <img id="avatar-preview" class="image-preview" src="">
                            <span>点击上传</span>
                        </div>
                        <input type="file" id="avatar-upload-input" class="hidden-file-input" accept="image/*">
                    </div>
                    <div class="form-group photo-group">
                        <label>AI 照片</label>
                        <div class="image-upload-area photo-upload" id="photo-upload-area">
                            <img id="photo-preview" class="image-preview" src="">
                            <span>点击上传</span>
                        </div>
                        <input type="file" id="photo-upload-input" class="hidden-file-input" accept="image/*">
                    </div>
                </div>
                <div class="form-group">
                    <label for="ai-editor-name">AI 姓名</label>
                    <input type="text" id="ai-editor-name">
                </div>
                <div class="form-group">
                    <label for="ai-editor-remark">AI 备注</label>
                    <input type="text" id="ai-editor-remark">
                </div>
                <div class="form-group">
                    <label for="ai-editor-persona">AI的人设</label>
                    <textarea id="ai-editor-persona" rows="5"></textarea>
                </div>
                <div class="form-group">
    <label for="ai-editor-public-card">公开名片 (对其他AI可见)</label>
    <textarea id="ai-editor-public-card" rows="3" placeholder="AI的公开简介，首次对话时可自动生成..."></textarea>
</div>
                <div class="form-group">
                    <label for="ai-editor-chat-style">线上风格</label>
                    <textarea id="ai-editor-chat-style" rows="4" placeholder="e.g., 喜欢用短句，偶尔会发可爱的Emoji、颜文字和表情包。不爱发语音，打字很快。说话直接，不喜欢拐弯抹角。"></textarea>
                </div>
                <div class="form-group"><label>AI的专属记忆 (线上模式)</label><textarea id="ai-editor-memory" rows="8" placeholder="线上闲聊的总结、长期记忆..."></textarea></div>
                <div class="form-group">
                    <label>世界书</label>
                    <div id="ai-editor-worldbook"></div>
                    <button type="button" id="add-worldbook-entry-button">添加新条目</button>
                </div>
                <div class="form-group">
                    <label>可用表情包分组</label>
                    <div id="ai-sticker-groups-container">
                        <p class="placeholder-text">请先在 全局设置 -> AI表情包管理 中添加分组</p>
                    </div>
                </div>
                <button id="save-ai-profile-button">保存</button>
            </div>
        </div>

        <!-- 【【【全新：用户表情包选择页面】】】 -->
        <div id="user-sticker-settings-view" class="view hidden">
            <div class="header">
                <button id="back-to-settings-from-user-sticker-btn" class="header-button back-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <span>我的表情包</span>
            </div>
            <div id="ai-editor-form" style="padding-top: 25px;">
                <div class="form-group">
                    <label>选择你想在聊天中使用的表情包分组</label>
                    <div id="user-sticker-groups-container">
                        <!-- 复选框将由JS动态生成在这里 -->
                    </div>
                </div>
                 <button id="save-user-sticker-settings-button" class="save-button" style="width: 100%; padding: 15px; border: none; background: var(--gradient-primary); color: white; border-radius: var(--radius-md); font-size: 16px; cursor: pointer;">保存</button>
            </div>
        </div>
        <!-- ▼▼▼ 【【【全新：账本视图】】】 ▼▼▼ -->
        <div id="ledger-view" class="view hidden">
            <div class="header">
                <button id="back-to-main-from-ledger" class="header-button back-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                <span>我的账本</span>
            </div>
            <div id="ledger-container" class="contact-settings-container">
                <!-- 账目列表将由JS动态生成在这里 -->
            </div>
            <button id="add-transaction-fab" class="fab">+</button>
        </div>

        <!-- ▼▼▼ 【【【全新：账本视图】】】 ▼▼▼ -->
            <div id="ledger-view" class="view hidden">
                <div class="header">
                    <button id="back-to-main-from-ledger" class="header-button back-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                    <span>我的账本</span>
                </div>
                <div id="ledger-container" class="contact-settings-container">
                    <!-- 账目列表将由JS动态生成在这里 -->
                </div>
                <button id="add-transaction-fab" class="fab">+</button>
            </div>
            
            <!-- ▼▼▼ 【【【全新：日记系统视图（已搬家到正确位置）】】】 ▼▼▼ -->
            <div id="diary-view" class="view hidden">
                <div class="header">
                    <button id="back-to-chat-from-diary" class="header-button back-button"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                    <span>日记本</span>
                </div>
                <!-- 日记切换标签 -->
                <div class="diary-tabs">
                    <button class="diary-tab-btn active" data-tab="my-diary">我的日记</button>
                    <button class="diary-tab-btn" data-tab="ai-diary">AI的日记</button>
                </div>
                <!-- 日记内容容器 -->
                <div class="diary-container">
                    <div id="my-diary-content" class="diary-tab-content active">
                        <!-- 我的日记内容将在这里显示 -->
                        <p class="placeholder-text" style="padding: 20px;">你还没有写过日记哦~</p>
                    </div>
                    <div id="ai-diary-content" class="diary-tab-content">
                        <!-- AI的日记内容将在这里显示 -->
                         <p class="placeholder-text" style="padding: 20px;">AI还没有写过日记呢~</p>
                    </div>
                </div>
                <button id="add-diary-entry-fab" class="fab">+</button>
            </div>
            <!-- ▲▲▲▲▲ 日记系统视图结束 ▲▲▲▲▲ -->

        </div> <!-- ▲▲▲ #app-container 到此彻底结束 ▲▲▲ -->

    <!-- 【【【核心终极修复：导航栏现在是 app-container 的兄弟！】】】 -->
    <div id="app-nav">
        <div class="nav-button active" data-view="chat-list-view">消息</div>
        <div class="nav-button" data-view="moments-view">动态</div>
        <div class="nav-button" data-view="settings-view">设置</div>
    </div>

    <!-- ############################################################### -->
    <!-- #####          所有的弹窗(Modal)都应该放在这里            ##### -->
    <!-- ############################################################### -->

        <!-- ▼▼▼ 【【【终极修复 V3.0：全屏日记查看器】】】 ▼▼▼ -->
    <div id="diary-viewer-modal" class="modal-overlay hidden">
        <div class="modal-content modal-fullscreen">
                        <div class="modal-header">
                <!-- 【【【核心最终修复：将标题和编辑按钮分组】】】 -->
                <div class="header-title-group">
                    <h3 id="diary-viewer-author"></h3>
                    <button id="edit-diary-fab" class="header-button-inline">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                    </button>
                </div>
                <button id="close-diary-viewer-btn" class="header-button close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div id="diary-viewer-content" class="diary-viewer-area">
                    <!-- 日记内容会显示在这里 -->
                </div>
            </div>
        </div>
    </div>
    <!-- ▲▲▲▲▲ 日记查看器弹窗结束 ▲▲▲▲▲ -->


            <!-- ▼▼▼ 【【【终极修复 V5.0：按需重构编辑器布局】】】 ▼▼▼ -->
    <div id="diary-editor-modal" class="modal-overlay hidden">
        <div class="modal-content modal-fullscreen">
            <!-- 头部现在是空的，因为所有东西都移到下面了 -->
            <div class="modal-header"></div>
            
            <div class="modal-body">
                <!-- 1. 工具栏现在是第一项 -->
                <div class="diary-toolbar">
                    <button class="tool-btn" data-format="bold" title="加粗"><svg viewBox="0 0 24 24"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg></button>
                    <button class="tool-btn" data-format="underline" title="下划线"><svg viewBox="0 0 24 24"><path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"></path><line x1="4" y1="21" x2="20" y2="21"></line></svg></button>
                    <button class="tool-btn" data-format="strikeThrough" title="删除线"><svg viewBox="0 0 24 24"><line x1="4" y1="12" x2="20" y2="12"></line><path d="M16 4H9a3 3 0 0 0-2.83 2M14 12a4 4 0 0 1 0 8H6"></path><path d="M4 12h16"></path></svg></button>
                    <label class="tool-btn color-picker-label" title="高亮颜色"><input type="color" id="diary-highlight-color-picker" class="color-picker-input" value="#FFEB3B"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg></label>
                    <label class="tool-btn color-picker-label" title="文字颜色"><input type="color" id="diary-text-color-picker" class="color-picker-input" value="#333333"><svg viewBox="0 0 24 24"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg></label>
                    <button class="tool-btn" data-command="changeFontSize" data-value="increase" title="放大字体"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                    <button class="tool-btn" data-command="changeFontSize" data-value="decrease" title="缩小字体"><svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                    <button class="tool-btn" data-format="justifyLeft" title="左对齐"><svg viewBox="0 0 24 24"><line x1="21" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="3" y2="18"></line></svg></button>
                    <button class="tool-btn" data-format="justifyCenter" title="居中对齐"><svg viewBox="0 0 24 24"><line x1="21" y1="10" x2="3" y2="10"></line><line x1="18" y1="6" x2="6" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="18" y1="18" x2="6" y2="18"></line></svg></button>
                    <button class="tool-btn" data-format="justifyRight" title="右对齐"><svg viewBox="0 0 24 24"><line x1="21" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="10" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="10" y2="18"></line></svg></button>
                    <button class="tool-btn" data-format="insertImage" title="插入图片"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></button>
                    <input type="file" id="diary-insert-image-input" accept="image/*" style="display: none;">
                    <button class="tool-btn" id="diary-set-bg-btn" title="设置背景"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M21 12.5V18a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.5"></path><path d="m14 4 3 3h-3V4z"></path><path d="M4 14.5l6-6 4 4L18.5 9"></path></svg></button>
                    <button class="tool-btn" id="diary-remove-bg-btn" title="移除背景"><svg viewBox="0 0 24 24"><path d="M12 22A10 10 0 1 1 12 2a10 10 0 0 1 0 20z"></path><path d="m15 9-6 6"></path><path d="m9 9 6 6"></path></svg></button>
                </div>
                
                <!-- 2. 标题栏是第二项 -->
                <div class="form-group" style="padding: 0 15px;">
                    <input type="text" id="diary-editor-title" placeholder="给日记起个标题吧..." style="width: 100%; border: none; border-bottom: 1px solid #eee; padding: 15px 0; font-size: 18px; font-weight: bold; background: none; outline: none;">
                </div>

                <!-- 3. 【重要】内容区和缩放条现在是邻居，方便定位 -->
                <div id="diary-editor-content-wrapper" style="position: relative; flex-grow: 1; min-height: 0;">
                    <div id="diary-editor-content" class="diary-editor-area" contenteditable="true" placeholder="今天发生了什么有趣的事吗..."></div>
                    <div id="image-resize-controls" class="hidden">
                        <span>图片大小:</span>
                        <input type="range" id="image-size-slider" min="10" max="100" value="100">
                    </div>
                </div>
            </div>
            
            <div class="modal-footer-combined">
                <div class="form-group visibility-selector">
                    <label for="diary-visibility-select">谁可以看</label>
                    <select id="diary-visibility-select">
                        <option value="all">所有AI可见</option>
                    </select>
                </div>
                <div class="footer-actions">
                    <button id="cancel-diary-btn" class="modal-button secondary">取消</button>
                    <button id="save-diary-btn" class="modal-button primary">保存</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ▲▲▲▲▲ 日记编辑器弹窗结束 ▲▲▲▲▲ -->

    <!-- 用户信息修改弹窗 -->
    <div id="user-profile-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h3>修改我的信息</h3><button id="close-modal-button" class="close-button">&times;</button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label>我的头像</label>
                    <div class="image-upload-area user-avatar-upload" id="user-avatar-upload-area">
                        <img id="user-avatar-preview" class="image-preview" src="">
                        <span>点击上传</span>
                    </div>
                    <input type="file" id="user-avatar-upload-input" class="hidden-file-input" accept="image/*">
                </div>
                <div class="form-group"><label for="modal-user-name-input">我的昵称</label><input type="text" id="modal-user-name-input"></div>
                <div class="form-group"><label for="modal-user-persona-input">我的人设</label><textarea id="modal-user-persona-input" rows="4"></textarea></div>
            </div>
            <div class="modal-footer"><button id="save-profile-button">保存</button></div>
        </div>
    </div> 

    <!-- 表情包上传弹窗 (V3.0 - 用户体验终极版) -->
    <div id="sticker-upload-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="sticker-upload-title">添加表情包</h3>
            </div>
            <div class="modal-body">
                <!-- ▼▼▼ 【【【全新：分组选择器 (保持不变)】】】 ▼▼▼ -->
                <div class="form-group">
                    <label for="sticker-upload-group-select">添加到分组</label>
                    <select id="sticker-upload-group-select"></select>
                </div>

                <!-- ▼▼▼ 【【【全新：上传模式切换标签页】】】 ▼▼▼ -->
                <div class="upload-mode-tabs">
                    <button id="tab-btn-local" class="tab-button active" data-tab="local">本地上传</button>
                    <button id="tab-btn-url" class="tab-button" data-tab="url">URL上传</button>
                </div>

                <!-- ▼▼▼ 【【【全新：两个独立的上传面板】】】 ▼▼▼ -->
                <div class="upload-panels-container">
                    <!-- 面板1: 本地上传 (对应您的图2) -->
                    <div id="panel-local" class="upload-panel active">
                        <div class="form-group">
                            <label for="sticker-upload-file-input" class="button-like-label">点此选择多张图片</label>
                            <input type="file" id="sticker-upload-file-input" class="hidden-file-input" accept="image/*" multiple>
                        </div>
                        <div id="local-preview-grid" class="local-preview-grid">
                            <!-- JS将在这里动态生成图片预览和描述框 -->
                        </div>
                    </div>

                    <!-- 面板2: URL上传 (V2.0 - 支持智能粘贴) -->
                    <div id="panel-url" class="upload-panel">
                        <!-- ▼▼▼ 【【【全新：智能粘贴区域】】】 ▼▼▼ -->
                        <div class="form-group smart-paste-area">
                            <textarea id="smart-paste-textarea" rows="4" placeholder="在此粘贴，格式为：&#10;描述1&#10;链接1&#10;描述2&#10;链接2..."></textarea>
                            <button id="parse-paste-btn" class="button-like-label" style="width:100%; margin-top:5px;">解析并填充下方列表</button>
                        </div>
                        <hr style="margin: 15px 0;">
                        <!-- ▲▲▲▲▲ -->
                        
                        <div id="url-input-pairs-container">
                            <!-- JS将在这里动态生成URL和描述的输入对 -->
                        </div>
                        <button id="add-url-pair-btn" class="add-more-button">+ 添加更多</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer-split">
                <button id="cancel-sticker-upload-btn" class="modal-button secondary">取消</button>
                <button id="confirm-sticker-upload-btn" class="modal-button primary">开始上传</button>
            </div>
        </div>
    </div>
     
    <!-- 发送语音弹窗 -->
    <div id="voice-input-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>发送语音</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="voice-text-input">请输入你想说的内容:</label>
                    <textarea id="voice-text-input" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer-split">
                <button id="cancel-voice-button" class="modal-button secondary">取消</button>
                <button id="confirm-voice-button" class="modal-button primary">确定</button>
            </div>
        </div>
    </div>

    <!-- AI图片描述弹窗 -->
    <div id="ai-image-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>照片描述</h3>
            </div>
            <div class="modal-body">
                <p id="ai-image-description-text"></p>
            </div>
            <div class="modal-footer">
                <button id="close-ai-image-modal-button">好的</button>
            </div>
        </div>
    </div>

    <!-- 用户上传/模拟图片弹窗 -->
    <div id="image-upload-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="image-upload-title">发送图片</h3>
            </div>
            <div class="modal-body">
                <div class="form-group" id="image-preview-area">
                    <div class="image-upload-area" id="user-image-upload-area">
                        <img id="user-image-preview" class="image-preview" src="">
                        <span>点击上传</span>
                    </div>
                    <input type="file" id="user-image-upload-input" class="hidden-file-input" accept="image/*">
                </div>
                <div class="form-group" id="image-description-group">
                    <textarea id="image-description-input" rows="3" placeholder="可以对图片进行提问或补充说明..."></textarea>
                </div>
            </div>
            <div class="modal-footer-split">
                <button id="cancel-image-upload-button" class="modal-button secondary">取消</button>
                <button id="confirm-image-upload-button" class="modal-button primary">发送</button>
            </div>
        </div>
    </div>

    <!-- 自定义确认弹窗 -->
    <div id="custom-confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="custom-confirm-title">确认操作</h3>
            </div>
            <div class="modal-body">
                <p id="custom-confirm-text"></p>
            </div>
            <div class="modal-footer-split">
                <button id="custom-confirm-cancel-btn" class="modal-button secondary">取消</button>
                <button id="custom-confirm-ok-btn" class="modal-button primary">确定</button>
            </div>
        </div>
    </div>
    <!-- 【【【全新：带输入框的自定义弹窗 (Prompt)】】】 -->
        <div id="custom-prompt-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="custom-prompt-title">输入</h3>
                </div>
                <div class="modal-body">
                    <p id="custom-prompt-text" style="margin-bottom: 15px;"></p>
                    <input type="text" id="custom-prompt-input" class="modal-input">
                </div>
                <div class="modal-footer-split">
                    <button id="custom-prompt-cancel-btn" class="modal-button secondary">取消</button>
                    <button id="custom-prompt-ok-btn" class="modal-button primary">确认</button>
                </div>
            </div>
        </div>

    <!-- 红包详情弹窗 -->
    <div id="red-packet-modal" class="modal-overlay hidden">
        <div class="red-packet-content">
            <button id="close-rp-modal-button" class="close-button">&times;</button>
            <div class="rp-header">
                <img id="rp-sender-avatar" class="avatar" src="">
                <p id="rp-sender-name"></p>
                <p id="rp-blessing"></p>
                <div class="rp-amount-line">
                    <span class="rp-currency">¥</span>
                    <span id="rp-amount">0.00</span>
                </div>
                <p class="rp-status-text">收到的红包已存入余额</p>
            </div>
            <div class="rp-footer">
                <div id="rp-receiver-list"></div>
            </div>
        </div>
    </div>

    <!-- 自定义提示弹窗 -->
    <div id="custom-alert-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="custom-alert-title">提示</h3>
            </div>
            <div class="modal-body">
                <p id="custom-alert-text"></p>
            </div>
            <div class="modal-footer">
                <button id="custom-alert-ok-btn">确定</button>
            </div>
        </div>
    </div>

    <!-- 发送红包弹窗 -->
    <div id="red-packet-input-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>发送红包</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="rp-input-blessing">祝福语</label>
                    <input type="text" id="rp-input-blessing" value="恭喜发财">
                </div>
                <div class="form-group">
                    <label for="rp-input-amount">金额 (元)</label>
                    <input type="number" id="rp-input-amount" placeholder="0.00" step="0.01">
                </div>
            </div>
            <div class="modal-footer-split">
                <button id="cancel-rp-input-btn" class="modal-button secondary">取消</button>
                <button id="confirm-rp-input-btn" class="modal-button primary">塞钱进红包</button>
            </div>
        </div>
    </div>

    <!-- 记忆总结编辑弹窗 -->
    <div id="summary-editor-modal" class="modal-overlay hidden">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3>编辑记忆总结</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>AI总结的记忆草稿 (YAML格式):</label>
                    <textarea id="summary-editor-textarea" rows="12"></textarea>
                </div>
                <p id="summary-status-text" class="summary-status"></p>
            </div>
            <div class="modal-footer-split">
                <button id="cancel-summary-btn" class="modal-button secondary">取消</button>
                <button id="copy-summary-btn" class="modal-button secondary">复制到剪贴板</button>
                <button id="save-summary-btn" class="modal-button primary">存入AI记忆</button>
            </div>
        </div>
    </div>

    <!-- 总结模式选择弹窗 -->
    <div id="mode-select-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>请选择总结模式</h3>
            </div>
            <div class="modal-body">
                <p>AI将根据你选择的模式，采用不同的侧重点来总结你们的对话。</p>
                <div class="mode-select-buttons">
                    <button id="mode-online-btn" class="modal-button primary">线上闲聊模式</button>
                    <button id="mode-offline-btn" class="modal-button secondary">线下剧情模式</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 手动总结范围设置弹窗 -->
    <div id="summary-range-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>手动总结设置</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="summary-range-input">要总结最近的多少条消息？</label>
                    <input type="number" id="summary-range-input" placeholder="例如: 100">
                    <p style="font-size:12px; color:#999; margin-top:5px;">(不填则默认总结全部新消息)</p>
                </div>
            </div>
            <div class="modal-footer-split">
                <button id="cancel-summary-range-btn" class="modal-button secondary">取消</button>
                <button id="confirm-summary-range-btn" class="modal-button primary">下一步</button>
            </div>
        </div>
    </div>

    <!-- 关系确认弹窗 -->
    <div id="relationship-confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="relationship-confirm-title">情侣关系邀请</h3>
            </div>
            <div class="modal-body">
                <p id="relationship-confirm-text"></p>
            </div>
            <div class="modal-footer-split">
                <button id="relationship-confirm-refuse-btn" class="modal-button secondary">残忍拒绝</button>
                <button id="relationship-confirm-accept-btn" class="modal-button primary">接受邀请</button>
            </div>
        </div>
    </div>
    <!-- 【【【全新：文本编辑弹窗】】】 -->
    <div id="text-editor-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="text-editor-title">编辑消息</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <textarea id="text-editor-textarea" rows="5"></textarea>
                </div>
            </div>
            <div class="modal-footer-split">
                <button id="cancel-text-edit-btn" class="modal-button secondary">取消</button>
                <button id="save-text-edit-btn" class="modal-button primary">保存</button>
            </div>
        </div>
    </div>
    <!-- ▼▼▼ 【【【全新：账目编辑器弹窗 (用于添加和编辑)】】】 ▼▼▼ -->
    <div id="transaction-editor-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="transaction-editor-title">添加账目</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>类型</label>
                    <div id="tx-editor-type-selector" class="type-selector">
                        <button class="type-button active" data-type="expense">支出</button>
                        <button class="type-button" data-type="income">收入</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="tx-editor-desc-input">项目</label>
                    <input type="text" id="tx-editor-desc-input" placeholder="例如：奶茶 或 工资">
                </div>
                <div class="form-group">
                    <label for="tx-editor-amount-input">金额 (元)</label>
                    <input type="number" id="tx-editor-amount-input" placeholder="例如：15">
                </div>
                <div class="form-group">
                    <label for="tx-editor-remarks-input">备注 (选填)</label>
                    <textarea id="tx-editor-remarks-input" rows="3" placeholder="例如：给同事带的"></textarea>
                </div>
            </div>
            <div class="modal-footer-split">
                <button id="cancel-tx-editor-btn" class="modal-button secondary">取消</button>
                <button id="save-tx-editor-btn" class="modal-button primary">保存</button>
            </div>
        </div>
    </div>
    <!-- ▼▼▼ 【【【全新：记账弹窗】】】 ▼▼▼ -->
    <div id="accounting-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>快速记账</h3>
            </div>
            <div class="modal-body">
                <!-- 这里将显示已添加的条目 -->
                <div id="accounting-entry-list" style="margin-bottom: 15px;"></div>
                
                <!-- 这是输入新条目的区域 -->
                <div class="form-group" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- ▼▼▼ 【核心新增】在这里也加入类型选择器 ▼▼▼ -->
                    <div id="accounting-type-selector" class="type-selector">
                        <button class="type-button active" data-type="expense">支出</button>
                        <button class="type-button" data-type="income">收入</button>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="accounting-item-input" placeholder="买了什么？(如: 奶茶)" style="flex: 3;">
                        <input type="number" id="accounting-amount-input" placeholder="多少钱？" style="flex: 2;">
                    </div>
                    <input type="text" id="accounting-remarks-input" placeholder="备注 (选填，如: 少糖去冰)">
                </div>
                <button id="add-accounting-entry-btn" style="width:100%; padding:10px; margin-top:10px; background:none; border: 1px dashed #ccc; cursor:pointer;">+ 添加另一笔</button>
            </div>
            <div class="modal-footer-split">
                <button id="cancel-accounting-btn" class="modal-button secondary">取消</button>
                <button id="confirm-accounting-btn" class="modal-button primary">完成记账</button>
            </div>
        </div>
    </div>
    </div>
    </div>
<!-- ▼▼▼ 【【【全新：AI生活作息编辑器弹窗】】】 ▼▼▼ -->
    <div id="schedule-editor-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑生活作息</h3>
                <button id="close-schedule-editor-btn" class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 睡眠习惯 -->
<div class="form-group">
    <label>睡眠习惯</label>
    <div class="schedule-item-card">
        <select id="schedule-sleep-type" class="form-control">
            <option value="regular">规律作息</option>
            <option value="irregular">不规律作息</option>
        </select>
        <!-- 【核心改造】我们把这里也改成和“三餐”一样的垂直布局，彻底解决挤压问题 -->
        <div class="schedule-time-range vertical">
            <div class="time-input-row">
                <label for="schedule-sleep-start">睡觉时间</label>
                <input type="time" id="schedule-sleep-start" value="23:00">
            </div>
            <div class="time-input-row">
                <label for="schedule-sleep-end">起床时间</label>
                <input type="time" id="schedule-sleep-end" value="07:00">
            </div>
        </div>
    </div>
</div>
                <!-- ▼▼▼ 【【【全新：三餐时间】】】 ▼▼▼ -->
                <div class="form-group">
                    <label>三餐习惯</label>
                    <div class="schedule-item-card">
                        <select id="schedule-meals-type" class="form-control">
                            <option value="regular">三餐规律</option>
                            <option value="irregular">三餐不规律</option>
                        </select>
                        <!-- 【核心改造】我们为这个容器增加一个 "vertical" 标识，并重构内部结构 -->
                        <div class="schedule-time-range vertical">
                            <div class="time-input-row">
                                <label for="schedule-meals-breakfast">早餐时间</label>
                                <input type="time" id="schedule-meals-breakfast">
                            </div>
                            <div class="time-input-row">
                                <label for="schedule-meals-lunch">午餐时间</label>
                                <input type="time" id="schedule-meals-lunch">
                            </div>
                            <div class="time-input-row">
                                <label for="schedule-meals-dinner">晚餐时间</label>
                                <input type="time" id="schedule-meals-dinner">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ▲▲▲▲▲ 三餐时间结束 ▲▲▲▲▲ -->

                <!-- 工作/学习 -->
                <div class="form-group">
                    <label>工作/学习安排</label>
                    <div id="schedule-work-list">
                        <!-- 工作项将由JS动态生成在这里 -->
                    </div>
                    <button id="add-work-item-btn" class="add-schedule-item-btn">+ 添加工作项</button>
                </div>

                <!-- 休闲娱乐 -->
                <div class="form-group">
                    <label>休闲娱乐</label>
                    <div id="schedule-leisure-list">
                        <!-- 休闲项将由JS动态生成在这里 -->
                    </div>
                    <button id="add-leisure-item-btn" class="add-schedule-item-btn">+ 添加休闲活动</button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-schedule-btn" class="modal-button primary">保存作息</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲▲▲ 作息编辑器弹窗结束 ▲▲▲▲▲ -->
        <!-- ▼▼▼ 【【【全新：星期选择器弹窗】】】 ▼▼▼ -->
    <div id="day-selector-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 300px;">
            <div class="modal-header">
                <h3>选择重复日期</h3>
            </div>
            <div class="modal-body">
                <div id="day-selector-grid" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                    <!-- 星期按钮将由JS动态生成在这里 -->
                </div>
            </div>
            <div class="modal-footer-split">
                <button id="cancel-day-select-btn" class="modal-button secondary">取消</button>
                <button id="save-day-select-btn" class="modal-button primary">确定</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲▲▲ 星期选择器弹窗结束 ▲▲▲▲▲ -->
         <!-- ▼▼▼ 【【【全新 V2.0：单个作息项编辑器弹窗（精装修版）】】】 ▼▼▼ -->
    <div id="schedule-item-editor-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="schedule-item-editor-title">编辑活动</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>活动名称</label>
                    <input type="text" id="item-editor-name" class="form-control">
                </div>
                                <!-- 1. 【UI终极修复】恢复成和“睡眠习惯”一样的、最简单的垂直布局 -->
                <div class="schedule-time-range vertical">
                    <div class="time-input-row">
                        <label>开始时间</label>
                        <input type="time" id="item-editor-startTime">
                    </div>
                    <div class="time-input-row">
                        <label>结束时间</label>
                        <input type="time" id="item-editor-endTime">
                    </div>
                </div>
                <div class="time-input-row">
                    <label>重复日期</label>
                    <button id="item-editor-days-btn" class="schedule-display-btn">未设置</button>
                </div>
                <div class="time-input-row">
                    <label>发生概率</label>
                    <button id="item-editor-probability-btn" class="schedule-display-btn">100%</button>
                </div>
                <!-- 2. 【功能新增】在这里加上删除按钮 -->
                <div style="margin-top: 20px;">
                    <button id="delete-item-editor-btn" class="delete-schedule-item-btn" style="width: 100%;">删除此活动</button>
                </div>
            </div>
            <div class="modal-footer-split">
                <button id="cancel-item-editor-btn" class="modal-button secondary">取消</button>
                <button id="save-item-editor-btn" class="modal-button primary">保存</button>
            </div>
                </div>
    </div>
    <!-- ▲▲▲▲▲ 单个作息项编辑器弹窗结束 ▲▲▲▲▲ -->

    <!-- ▼▼▼ 【【【全新V2.0：剧情线驱动的线下模式设置弹窗】】】 ▼▼▼ -->
    <div id="offline-settings-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>设置线下模式</h3>
                <button id="close-offline-settings-btn" class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <!-- 1. 全新增加的剧情线选择器 -->
                <div class="form-group">
                    <label for="offline-storyline-select">为哪条剧情线进行设置？</label>
                    <select id="offline-storyline-select"></select>
                </div>
                <hr>
                <!-- 2. 下面的所有设置都将与上面选择的剧情线绑定 -->
                <div class="form-group">
                    <label for="offline-word-limit">单次回复字数限制</label>
                    <input type="number" id="offline-word-limit" placeholder="建议200-500，0为不限制">
                </div>
                <div class="form-group">
                    <label for="offline-perspective">叙事视角</label>
                    <select id="offline-perspective">
                        <option value="second-person">第二人称 (你...)</option>
                        <option value="third-person">第三人称 (他/她...)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>AI行为控制</label>
                    <div class="settings-item" style="padding: 0;">
                        <span>防抢话</span>
                        <label class="switch"><input type="checkbox" id="offline-prevent-control-toggle"><span class="slider"></span></label>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="offline-start-prompt">剧情设定 (选填)</label>
                    <textarea id="offline-start-prompt" rows="3" placeholder="输入你想让AI作为故事开头的引导语..."></textarea>
                </div>
                <!-- 3. 全新增加的AI开场白输入框 -->
                <div class="form-group">
                    <label for="offline-opening-remark">AI开场白 (选填)</label>
                    <textarea id="offline-opening-remark" rows="3" placeholder="AI将自动发送这段内容，作为本剧情线的开场白..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="save-offline-settings-btn">保存设置</button>
            </div>
        </div>
    </div>
    <!-- ▲▲▲▲▲ 线下模式设置弹窗结束 ▲▲▲▲▲ -->
         <!-- ▼▼▼ 【【【全新：通用模式选择弹窗】】】 ▼▼▼ -->
    <div id="generic-mode-select-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="generic-mode-select-title">请选择操作的模式</h3>
                <button id="close-generic-mode-select-btn" class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mode-select-buttons">
                    <button id="generic-mode-online-btn" class="modal-button primary">线上模式</button>
                    <button id="generic-mode-offline-btn" class="modal-button secondary">线下模式</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ▲▲▲▲▲ 通用模式选择弹窗结束 ▲▲▲▲▲ -->


    <!-- ▼▼▼ 【【【全新：引入flatpickr日历功能】】】 ▼▼▼ -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script> <!-- 引入中文语言包 -->
    <script src="script.js"></script>

    <!-- 【【【全新：剧情线选择弹窗 (V3.0 下拉菜单版)】】】 -->
    <div class="modal-overlay hidden" id="storyline-select-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="storyline-select-title">选择剧情线</h3>
            </div>
            <div class="modal-body">
                <!-- 核心改造：使用form-group来包裹下拉菜单，自动美化 -->
                <div class="form-group">
                    <select id="storyline-select-dropdown"></select>
                </div>
            </div>
            <div class="modal-footer-split">
                <button id="cancel-storyline-select-btn" class="modal-button secondary">取消</button>
                <!-- 核心新增：添加一个“确定”按钮 -->
                <button id="confirm-storyline-select-btn" class="modal-button primary">确定</button>
            </div>
        </div>
    </div>
    </div>
</div>

<!-- ▼▼▼ 【【【全新：剧情线编辑器弹窗】】】 ▼▼▼ -->
<div id="storyline-editor-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="storyline-editor-title">编辑剧情线</h3>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="storyline-editor-name">存档名称</label>
                <input type="text" id="storyline-editor-name">
            </div>
            <div class="form-group">
                <label for="storyline-editor-memory">剧情记忆</label>
                <textarea id="storyline-editor-memory" rows="10" placeholder="这条剧情线里发生过的关键故事..."></textarea>
            </div>
        </div>
        <div class="modal-footer-split">
            <button id="cancel-storyline-edit-btn" class="modal-button secondary">取消</button>
            <button id="save-storyline-edit-btn" class="modal-button primary">保存</button>
        </div>
    </div>
</div>
<!-- ▲▲▲▲▲ 弹窗添加完毕 ▲▲▲▲▲ -->



<!-- ▼▼▼ 【【【全新：AI主动消息顶部通知弹窗】】】 ▼▼▼ -->
<div id="proactive-notification-popup" class="notification-popup">
    <div class="notification-content">
        <img id="notification-avatar" class="avatar" src="">
        <div class="notification-text">
            <span id="notification-name" class="sender-name"></span>
            <span id="notification-message" class="message-preview"></span>
        </div>
    </div>
</div>
<!-- ▲▲▲▲▲ 通知弹窗结束 ▲▲▲▲▲ -->
<!-- ▼▼▼ 【【【全新：全局加载动画遮罩层 (V2.0 带进度条版)】】】 ▼▼▼ -->
<div id="loading-overlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
    <p id="loading-text" class="loading-text">正在登录中...</p>
</div>
<!-- ▲▲▲▲▲ 加载动画结束 ▲▲▲▲▲ -->
</body>
</html>
